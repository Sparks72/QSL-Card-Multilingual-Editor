<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customizable QSL Card - Standard 140x90mm Size</title>
<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background-color: #f0f0f0;
    text-align: left;
}
.container {
    max-width: 100%;
    margin: 0 auto;
    position: relative;
}

/* Main content wrapper - Fixed layout */
.main-content-wrapper {
    display: flex;
    flex-wrap: wrap;
    margin-top: 20px;
    gap: 20px;
}

.settings-panel {
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 5mm;
    padding: 15px;
    box-sizing: border-box;
    width: 500px;
    max-width: 100%;
    max-height: calc(100vh - 120px); /* Adjusted for header */
    overflow-y: auto;
    overflow-x: hidden;
    flex: 1;
    min-width: 320px;
}
.settings-section {
    margin-bottom: 10px;
}
.settings-title {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 10px;
    color: #1a4e8c;
}
.settings-subtitle {
    font-size: 14px;
    font-weight: bold;
    margin: 10px 0 5px;
    color: #555;
}
.form-group {
    margin-bottom: 8px;
    display: flex;
    align-items: center;
}
.form-group label {
    width: 120px;
    font-size: 14px;
    flex-shrink: 0;
}
.form-group input[type="text"],
.form-group input[type="color"],
.form-group input[type="file"],
.form-group select,
.form-group input[type="range"] {
    flex: 1;
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 3px;
    min-width: 50px; /* Prevent excessive shrinking */
}
.form-group input[type="color"] {
    padding: 2px; /* Adjust padding for color input */
    min-height: 25px; /* Ensure color input height */
}
.form-group input[type="range"] {
     padding: 0; /* Remove padding for range */
}
.form-group span { /* Span for range value */
    margin-left: 5px;
    min-width: 40px;
    text-align: right;
}

.settings-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 10px;
}
.settings-col {
    flex: 1;
    min-width: 250px;
}

/* Fixed card preview area */
.card-preview-area {
    width: 140mm; /* Fixed width for preview */
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-shrink: 0; /* Prevent shrinking */
    position: sticky; /* Keep preview visible */
    top: 20px;
}

/* QSL Card Styles */
.qsl-card {
    width: 140mm;
    height: 90mm;
    margin-bottom: 15px;
    border: 2px solid #1a4e8c;
    background-color: #1a4e8c;
    padding: 3mm;
    border-radius: 3mm;
    box-sizing: border-box;
    overflow: hidden;
    flex-shrink: 0;
    position: relative; /* Needed for absolute positioning context */
}
.inner-card {
    background-color: white;
    padding: 2mm;
    border-radius: 2mm;
    height: 100%;
    box-sizing: border-box;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}
.card-content {
    background-color: transparent; /* Overlay will handle color */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    color: gold; /* Default, will be overridden */
    padding: 0; /* Padding handled by overlay */
    position: relative;
    height: 65mm;
    border: 0.5mm solid #ccc;
    box-sizing: border-box;
    overflow: hidden;
    border-radius: 2mm;
    margin-bottom: 1mm;
}
.card-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(26, 123, 205, 0.3); /* Default overlay */
    padding: 3mm;
    border-radius: 2mm;
    box-sizing: border-box; /* Include padding in dimensions */
}
.text-container {
    position: relative; /* Positioning context for draggables */
    z-index: 10;
    height: 100%;
    width: 100%;
    overflow: hidden; /* Clip text that goes outside */
}
.text-container .callsign#displayCallsign1,
.text-container .callsign#displayCallsign2 {
    font-size: 16mm; /* Default size */
}

/* Draggable Styles */
.draggable {
    position: absolute;
    cursor: move;
    user-select: none;
    -webkit-user-select: none;
    padding: 2px;
    z-index: 20;
    white-space: nowrap; /* Prevent text wrapping during drag */
}
.drag-mode .draggable:hover {
    outline: 1px dashed rgba(255, 255, 255, 0.5);
}
.draggable.active {
    outline: 2px solid rgba(255, 255, 255, 0.8);
    z-index: 30; /* Bring active element to front */
}
.draggable-visible { /* Persistent outline when checkbox is checked */
    outline: 1px dashed rgba(255, 255, 255, 0.5);
}
/* Text Styles */
.callsign {
    font-size: 16mm;
    font-weight: bold;
    margin-bottom: 1mm;
    color: #E6B800; /* Default */
    text-shadow: 1mm 1mm 2mm rgba(0, 0, 0, 0.7);
}
.subtitle {
    font-size: 5mm;
    margin-bottom: 1mm;
    color: #E6B800;
    text-shadow: 1mm 1mm 2mm rgba(0, 0, 0, 0.7);
}
.location {
    font-size: 5mm;
    text-align: right;
    color: #E6B800;
    text-shadow: 1mm 1mm 2mm rgba(0, 0, 0, 0.7);
}
.grid {
    font-size: 5mm;
    text-align: right;
    color: #E6B800;
    text-shadow: 1mm 1mm 2mm rgba(0, 0, 0, 0.7);
}
/* QSO Table Styles */
.qso-table {
    width: 100%;
    border-collapse: collapse;
    margin: 0;
    padding: 0;
    font-size: 2.7mm; /* Base size */
    height: 16mm; /* Approximate height */
    flex-grow: 1; /* Allow table to take remaining space */
    table-layout: fixed; /* Helps with consistent column widths */
}
.qso-table td, .qso-table th {
    border: 0.2mm solid black;
    padding: 0.8mm 0.2mm;
    text-align: center;
    vertical-align: middle;
    height: auto;
    overflow: hidden; /* Prevent text overflow */
    white-space: nowrap; /* Prevent header wrapping */
}
.qso-table input[type="text"] {
    width: 95%;
    height: 4.5mm;
    padding: 0.3mm;
    box-sizing: border-box;
    font-size: 3mm;
    text-align: center;
    border: 1px solid #ccc; /* Add border for visibility */
    border-radius: 2px;
}
.confirm-row {
    height: 5mm;
}
.confirm-row input {
    width: 95%;
    height: 4mm;
    margin: 0;
    font-size: 3mm;
    text-align: center;
}
.confirm-text {
    font-size: 2.7mm;
    margin-right: 1mm;
}
.qsl-checkbox-cell {
    vertical-align: middle;
    width: 10%; /* Adjusted width */
}
.checkbox-container {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    align-items: center;
    height: 100%;
    font-size: 2.5mm;
}
.checkbox-container div {
    display: flex;
    align-items: center;
    white-space: nowrap;
    margin: 0.2mm 0;
}
.checkbox-container input[type="checkbox"] {
    transform: scale(0.7);
    margin: 0 0 0 0.5mm;
    vertical-align: middle;
}
/* Action Buttons */
.action-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    width: 100%;
    margin-top: 10px; /* Add some space */
}
.action-button {
    padding: 8px 15px;
    background-color: #1a4e8c;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    min-width: 100px;
}
.action-button:hover {
    background-color: #15407a;
}
.action-button.secondary {
    background-color: #777;
}
.action-button.secondary:hover {
    background-color: #666;
}
/* Language Selector etc */
.language-selector {
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    padding-left: 20px; /* Align with container padding */
    background-color: #e9e9e9; /* Add slight background */
    padding: 10px;
    border-radius: 5px;
}
.language-selector select {
    padding: 6px;
    border-radius: 4px;
    border: 1px solid #ccc;
}
.collapse-button {
    background-color: #ddd;
    color: #333;
    border: none;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 14px;
    border-radius: 3px;
    margin-right: 10px;
}
/* Position Controls within Settings */
.position-controls {
    display: none; /* Hidden by default */
    margin-top: 10px;
    padding: 10px;
    background-color: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 5px;
}
.position-controls-title {
    font-weight: bold;
    margin-bottom: 5px;
}
.position-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}
.position-action {
    padding: 5px 10px;
    background-color: #ddd;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
}
.position-checkbox {
    margin-top: 10px;
}

/* Hidden file input for loading settings */
#settingsFileInput {
    display: none;
}

/* Responsive adjustments */
@media (max-width: 1000px) { /* Adjust breakpoint */
    .main-content-wrapper {
        flex-direction: column;
        align-items: center; /* Center items when stacked */
    }
    .settings-panel {
        width: 100%;
        max-width: 700px; /* Limit width on smaller screens */
        max-height: none;
        overflow-y: visible;
        margin-bottom: 20px;
        order: 2; /* Settings below card */
    }
    .card-preview-area {
        width: 100%;
        max-width: 140mm; /* Ensure card fits */
        margin: 0 auto 20px auto; /* Center and add bottom margin */
        position: relative; /* Reset sticky */
        top: auto;
        order: 1; /* Card above settings */
    }
    .card-preview-area .qsl-card {
        margin-left: auto;
        margin-right: auto;
    }
    .language-selector {
        padding-left: 10px;
    }
}

@media print {
    body {
        padding: 0;
        margin: 0;
        background: none;
        overflow: visible !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    .container {
        max-width: none;
        padding: 0;
        margin: 0;
    }
    .settings-panel, .action-buttons, .language-selector, .collapse-button, .position-controls, .main-content-wrapper > *:not(.card-preview-area) {
        display: none !important; /* Hide everything except the preview area */
    }
    .main-content-wrapper {
        display: block !important; /* Override flex for print */
        margin: 0 !important;
        padding: 0 !important;
        gap: 0 !important;
    }
     .card-preview-area {
        position: absolute !important; /* Ensure it's positioned for printing */
        top: 0 !important;
        left: 0 !important;
        width: 140mm !important;
        height: 90mm !important;
        margin: 0 !important;
        padding: 0 !important;
        page-break-before: auto;
        page-break-after: always; /* Ensure one card per page */
        page-break-inside: avoid;
        transform: none !important;
    }
    .qsl-card {
        width: 140mm !important;
        height: 90mm !important;
        margin: 0 !important;
        padding: 3mm !important;
        border: 2px solid var(--print-border-color, #1a4e8c) !important;
        background-color: var(--print-bg-color, #1a4e8c) !important;
        box-sizing: border-box !important;
        overflow: hidden !important;
        border-radius: 3mm !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    .inner-card {
        background-color: white !important;
        padding: 2mm !important;
        border-radius: 2mm !important;
        height: 100% !important;
        box-sizing: border-box !important;
        overflow: hidden !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    .card-content {
        height: 65mm !important;
        border: 0.5mm solid #ccc !important;
        border-radius: 2mm !important;
        margin-bottom: 1mm !important;
        background-image: var(--print-card-bg-image) !important;
        background-size: cover !important;
        background-position: center !important;
        background-repeat: no-repeat !important;
        position: relative !important;
        box-sizing: border-box !important;
        overflow: hidden !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    .card-overlay {
        position: absolute !important;
        top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important;
        padding: 3mm !important;
        border-radius: 2mm !important;
        background-color: var(--print-overlay-bg-color) !important;
        box-sizing: border-box !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    .text-container {
        position: relative !important;
        z-index: 10 !important;
        height: 100% !important;
        width: 100% !important;
        overflow: hidden !important;
    }
    /* Force text colors and styles for print */
    .callsign, .subtitle, .location, .grid {
        color: var(--print-text-color) !important;
        text-shadow: 1mm 1mm 2mm rgba(0, 0, 0, 0.7) !important;
        position: absolute !important; /* Ensure position is respected */
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    /* Force specific font sizes for print */
    #displayCallsign1 { font-size: var(--print-callsign1-size) !important; }
    #displayCallsign2 { font-size: var(--print-callsign2-size) !important; }
    /* Ensure QSO table prints correctly */
    .qso-table {
        font-family: var(--print-qso-font) !important;
        font-size: 2.7mm !important;
        height: 16mm !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    .qso-table td, .qso-table th {
        border: 0.2mm solid black !important;
        padding: 0.8mm 0.2mm !important;
         -webkit-print-color-adjust: exact !important;
         print-color-adjust: exact !important;
    }
    /* Hide input fields, show their values (or leave blank) */
    .qso-table input[type="text"] {
        display: none !important; /* Hide inputs */
         /* Optionally, add spans to show values if needed, or just leave cells blank/styled */
    }
    .qso-table input[type="checkbox"] {
        display: inline-block !important; /* Keep checkboxes visible */
        appearance: checkbox !important; /* Force browser default */
        -webkit-appearance: checkbox !important;
        opacity: 1 !important;
        border: 1px solid black !important; /* Make border visible */
         -webkit-print-color-adjust: exact !important;
         print-color-adjust: exact !important;
    }
    
	.qso-table input[type="text"] {
        display: inline-block !important; /* Make sure it's displayed */
        width: 100% !important;           /* Fill the cell width */
        height: auto !important;           /* Adjust height automatically */
        padding: 0 !important;             /* Remove input padding */
        margin: 0 !important;              /* Remove input margin */
        border: none !important;           /* Remove the input border */
        background-color: transparent !important; /* Make background transparent */
        font-family: var(--print-qso-font) !important; /* Use table font */
        font-size: inherit !important;     /* Inherit font size from cell */
        color: black !important;           /* Ensure text is black */
        text-align: center !important;     /* Keep text centered */
        vertical-align: middle !important; /* Align vertically */
        box-shadow: none !important;       /* Remove any shadow */
        appearance: none !important;       /* Remove native appearance */
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        box-sizing: border-box !important; /* Ensure width includes no border/padding */
        /* You might need to add this if text is slightly off vertically */
        /* line-height: normal !important; */
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
   .qso-table td {
        padding: 0.8mm 0.2mm !important; /* Keep original padding or adjust slightly if needed */
        vertical-align: middle !important;
        /* text-align: center !important; */ /* Text align applied to input now */
     }
	
	
	.checkbox-container span {
         -webkit-print-color-adjust: exact !important;
         print-color-adjust: exact !important;
    }
     .draggable {
        cursor: default !important; /* No move cursor on print */
        outline: none !important; /* No outlines on print */
    }

    @page {
        size: 140mm 90mm;
        margin: 0;
    }






}

/* Scrollbar styling */
.settings-panel::-webkit-scrollbar {
  width: 8px;
}
.settings-panel::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}
.settings-panel::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 4px;
}
.settings-panel::-webkit-scrollbar-thumb:hover {
  background: #aaa;
}
</style>
</head>
<body>
<div class="container">
    <div class="language-selector">
        <button id="toggleSettings" class="collapse-button">Hide Settings</button>
        <label for="languageSelect">Language:</label>
        <select id="languageSelect">
            <option value="en">English</option>
            <option value="de">German (Deutsch)</option>
            <option value="fr">French (Français)</option>
            <option value="es">Spanish (Español)</option>
            <option value="custom">Custom</option>
        </select>
        <button id="saveSettingsBtn" class="action-button secondary">Save Settings</button>
        <button id="loadSettingsBtn" class="action-button secondary">Load Settings (File)</button>
        <input type="file" id="settingsFileInput" accept=".json"> <!-- Keep hidden input -->
    </div>

    <!-- Main wrapper for side-by-side content -->
    <div class="main-content-wrapper">

        <!-- Settings Panel Column -->
        <div id="settingsPanel" class="settings-panel">
            <div class="settings-title">QSL Card Customization</div>

            <div class="settings-row">
                <!-- Column 1: Callsign Info -->
                <div class="settings-col">
                    <div class="settings-subtitle">Callsign Information</div>
                    <div class="form-group">
                        <label for="callsign1">Callsign 1:</label>
                        <input type="text" id="callsign1" value="DJOCU">
                    </div>
                    <div class="form-group">
                        <label for="callsign2">Callsign 2:</label>
                        <input type="text" id="callsign2" value="G4ADF">
                    </div>
                    <div class="form-group">
                        <label for="subtitle1">Subtitle 1:</label>
                        <input type="text" id="subtitle1" value="DOK M08">
                    </div>
                    <div class="form-group">
                        <label for="subtitle2">Subtitle 2:</label>
                        <input type="text" id="subtitle2" value="72/73 de Paul">
                    </div>
                    <div class="form-group">
                        <label for="location">Location:</label>
                        <input type="text" id="location" value="Fehmarn, Germany">
                    </div>
                    <div class="form-group">
                        <label for="grid">Grid:</label>
                        <input type="text" id="grid" value="JO54OK">
                    </div>
                </div>

                <!-- Column 2: Table Headers -->
                <div class="settings-col">
                    <div class="settings-subtitle">Table Headers</div>
                    <div class="form-group">
                        <label for="headerDate">Date:</label>
                        <input type="text" id="headerDate" value="Date">
                    </div>
                    <div class="form-group">
                        <label for="headerMonth">Month:</label>
                        <input type="text" id="headerMonth" value="Month">
                    </div>
                    <div class="form-group">
                        <label for="headerDay">Day:</label>
                        <input type="text" id="headerDay" value="Day">
                    </div>
                    <div class="form-group">
                        <label for="headerUTC">UTC:</label>
                        <input type="text" id="headerUTC" value="UTC">
                    </div>
                    <div class="form-group">
                        <label for="headerBand">Band:</label>
                        <input type="text" id="headerBand" value="Band">
                    </div>
                    <div class="form-group">
                        <label for="headerRST">RST:</label>
                        <input type="text" id="headerRST" value="RST">
                    </div>
                    <div class="form-group">
                        <label for="headerMode">Mode:</label>
                        <input type="text" id="headerMode" value="Mode">
                    </div>
                    <div class="form-group">
                        <label for="headerQSL">QSL:</label>
                        <input type="text" id="headerQSL" value="QSL?">
                    </div>
                </div>

                <!-- Column 3: Options, Colors, Fonts -->
                <div class="settings-col">
                    <div class="settings-subtitle">QSL Options & Text</div>
                    <div class="form-group">
                        <label for="textPSE">PSE Text:</label>
                        <input type="text" id="textPSE" value="PSE">
                    </div>
                    <div class="form-group">
                        <label for="textTNX">TNX Text:</label>
                        <input type="text" id="textTNX" value="TNX">
                    </div>
                    <div class="form-group">
                        <label for="confirmText">Confirm Text:</label>
                        <input type="text" id="confirmText" value="Confirm QSO with:">
                    </div>

                    <div class="settings-subtitle">Colors</div>
                    <div class="form-group">
                        <label for="cardBorderColor">Card Border:</label>
                        <input type="color" id="cardBorderColor" value="#1a4e8c">
                    </div>
                    <div class="form-group">
                        <label for="textColor">Text Color:</label>
                        <input type="color" id="textColor" value="#E6B800">
                    </div>
                    <div class="form-group">
                        <label for="overlayColor">Overlay Color:</label>
                        <input type="color" id="overlayColor" value="#1a7bcd">
                    </div>

                    <div class="settings-subtitle">Fonts</div>
                    <div class="form-group">
                        <label for="cardFont">Card Font:</label>
                        <select id="cardFont">
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'Courier New', monospace">Courier New</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                            <option value="Verdana, sans-serif">Verdana</option>
                            <option value="Impact, sans-serif">Impact</option>
                            <option value="'Arial Black', sans-serif">Arial Black</option>
                            <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="qsoFont">QSO Font:</label>
                        <select id="qsoFont">
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'Courier New', monospace">Courier New</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                            <option value="Verdana, sans-serif">Verdana</option>
                            <option value="'Lucida Console', monospace">Lucida Console</option>
                        </select>
                    </div>

                    <div class="settings-subtitle">Font Sizes</div>
                    <div class="form-group">
                        <label for="callsign1Size">Callsign 1 Size:</label>
                        <input type="range" id="callsign1Size" min="8" max="24" value="16" step="1">
                        <span id="callsign1SizeValue">16mm</span>
                    </div>
                    <div class="form-group">
                        <label for="callsign2Size">Callsign 2 Size:</label>
                        <input type="range" id="callsign2Size" min="8" max="24" value="16" step="1">
                        <span id="callsign2SizeValue">16mm</span>
                    </div>
                </div>
            </div><!-- End Settings Row -->

            <div class="settings-section">
                <div class="settings-subtitle">Background Image</div>
                <div class="form-group">
                    <label for="bgImageFile">Image:</label>
                    <input type="file" id="bgImageFile" accept="image/*">
                    <button id="updateBgBtn" class="action-button secondary" style="margin-left: 5px;">Update</button>
                    <button id="removeBgBtn" class="action-button secondary" style="margin-left: 5px;">Remove</button>
                </div>
                <div class="form-group">
                    <label for="overlayOpacity">Overlay Opacity:</label>
                    <input type="range" id="overlayOpacity" min="0" max="100" value="30" step="1">
                    <span id="opacityValue">30%</span>
                </div>
            </div>

            <!-- Position Controls Section -->
            <div class="settings-section">
                <div class="settings-subtitle">Text Position</div>
                <div class="form-group">
                    <label>Positioning:</label>
                    <button id="toggleDraggableBtn" class="action-button secondary">Enable Drag Mode</button>
                </div>
                <div id="positionControls" class="position-controls">
                    <div class="position-controls-title">Position Controls (for active or all elements)</div>
                    <div class="position-buttons">
                        <button class="position-action" data-action="alignLeft">Align Left</button>
                        <button class="position-action" data-action="alignCenter">Align Center</button>
                        <button class="position-action" data-action="alignRight">Align Right</button>
                        <button class="position-action" data-action="alignTop">Align Top</button>
                        <button class="position-action" data-action="alignMiddle">Align Middle</button>
                        <button class="position-action" data-action="alignBottom">Align Bottom</button>
                        <button class="position-action" data-action="reset">Reset Positions</button>
                    </div>
                    <div class="position-checkbox">
                        <label>
                            <input type="checkbox" id="showOutlines"> Show text element outlines
                        </label>
                    </div>
                </div>
            </div>
        </div> <!-- End Settings Panel -->

        <!-- QSL Card Preview Column -->
        <div class="card-preview-area">
            <div class="qsl-card">
                <div class="inner-card">
                    <div class="card-content" id="cardContentArea"> <!-- Added ID for easier selection -->
                        <div class="card-overlay">
                            <div class="text-container">
                                <div class="callsign draggable" id="displayCallsign1" data-default-left="3mm" data-default-top="3mm">DJOCU</div>
                                <div class="callsign draggable" id="displayCallsign2" data-default-left="3mm" data-default-top="20mm">G4ADF</div>
                                <div class="subtitle draggable" id="displaySubtitle1" data-default-left="3mm" data-default-top="40mm">DOK M08</div>
                                <div class="subtitle draggable" id="displaySubtitle2" data-default-left="3mm" data-default-top="47mm">72/73 de Paul</div>
                                <div class="location draggable" id="displayLocation" data-default-right="3mm" data-default-bottom="10mm">Fehmarn, Germany</div>
                                <div class="grid draggable" id="displayGrid" data-default-right="3mm" data-default-bottom="3mm">JO54OK</div>
                            </div>
                        </div>
                    </div>
                    <table class="qso-table">
                        <thead> <!-- Added thead for structure -->
                            <tr>
                                <th id="displayHeaderDate">Date</th>
                                <th id="displayHeaderMonth">Month</th>
                                <th id="displayHeaderDay">Day</th>
                                <th id="displayHeaderUTC">UTC</th>
                                <th id="displayHeaderBand">Band</th>
                                <th id="displayHeaderRST">RST</th>
                                <th id="displayHeaderMode">Mode</th>
                                <th id="displayHeaderQSL">QSL?</th>
                            </tr>
                        </thead>
                        <tbody> <!-- Added tbody -->
                            <tr>
                                <td><input type="text" name="date" aria-label="QSO Date"></td>
                                <td><input type="text" name="month" aria-label="QSO Month"></td>
                                <td><input type="text" name="day" aria-label="QSO Day"></td>
                                <td><input type="text" name="utc" aria-label="QSO UTC Time"></td>
                                <td><input type="text" name="band" aria-label="QSO Band"></td>
                                <td><input type="text" name="rst" aria-label="QSO RST"></td>
                                <td><input type="text" name="mode" aria-label="QSO Mode"></td>
                                <td class="qsl-checkbox-cell">
                                    <div class="checkbox-container">
                                        <div><span id="displayTextPSE">PSE</span> <input type="checkbox" name="pse" aria-label="QSL Please"></div>
                                        <div><span id="displayTextTNX">TNX</span> <input type="checkbox" name="tnx" aria-label="QSL Thanks"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr class="confirm-row">
                                <td colspan="7"><span class="confirm-text" id="displayConfirmText">Confirm QSO with:</span> <input type="text" name="qso_with" aria-label="Confirm QSO with Callsign"></td>
                                <td></td> <!-- Empty cell to align with QSL column -->
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="action-buttons">
                <button id="printBtn" class="action-button">Print QSL Card</button>
                <button id="saveAsBtn" class="action-button">Save Settings (File)</button>
                <button id="resetBtn" class="action-button secondary">Reset to Default</button>
            </div>
        </div> <!-- End Card Preview Area -->

    </div> <!-- End Main Content Wrapper -->

</div> <!-- End Container -->

<script>
// Language Presets (Ensure defaults match initial HTML values if needed)
const languagePresets = {
    en: {
        callsign1: "A8ABC", // Changed default
        callsign2: "A8ABC", // Changed default
        subtitle1: "DOK ABC", // Changed default
        subtitle2: "72/73 de Paul", // Changed default
        location: "Berlin, Germany", // Changed default
        grid: "JO54OK",     // Changed default
        headerDate: "Date",
        headerMonth: "Month",
        headerDay: "Day",
        headerUTC: "UTC",
        headerBand: "Band",
        headerRST: "RST",
        headerMode: "Mode",
        headerQSL: "QSL?",
        textPSE: "PSE",
        textTNX: "TNX",
        confirmText: "Confirm QSO with:"
    },
    de: {
        callsign1: "A8ABC",
        callsign2: "A8ABC",
        subtitle1: "DOK XYZ",
        subtitle2: "72/73 de Paul",
        location: "Berlin, Deutschland", // German location
        grid: "JO54OK",
        headerDate: "Datum",
        headerMonth: "Monat",
        headerDay: "Tag",
        headerUTC: "UTC",
        headerBand: "Band",
        headerRST: "RST",
        headerMode: "Mode",
        headerQSL: "QSL?",
        textPSE: "BITTE",
        textTNX: "DANKE",
        confirmText: "Bestätigung QSO mit:"
    },
    fr: {
        callsign1: "A8ABC",
        callsign2: "A8ABC",
        subtitle1: "DOK XYZ",
        subtitle2: "72/73 de Paul",
        location: "Berlin, Allemagne", // French location
        grid: "JO54OK",
        headerDate: "Date",
        headerMonth: "Mois",
        headerDay: "Jour",
        headerUTC: "UTC",
        headerBand: "Bande",
        headerRST: "RST",
        headerMode: "Mode",
        headerQSL: "QSL?",
        textPSE: "SVP",
        textTNX: "MERCI",
        confirmText: "Confirmer QSO avec:"
    },
    es: {
        callsign1: "A8ABC",
        callsign2: "A8ABC",
        subtitle1: "DOK xyz",
        subtitle2: "72/73 de Paul",
        location: "Berlin, Alemania", // Spanish location
        grid: "JO54OK",
        headerDate: "Fecha",
        headerMonth: "Mes",
        headerDay: "Día",
        headerUTC: "UTC",
        headerBand: "Banda",
        headerRST: "RST",
        headerMode: "Modo",
        headerQSL: "QSL?",
        textPSE: "POR FAVOR",
        textTNX: "GRACIAS",
        confirmText: "Confirmar QSO con:"
    }
};

// --- Global Variables ---
let currentBgImage = null; // Store background image data URL

// --- Utility Functions ---
function updateDisplayText() {
    try {
        // Update text elements based on input values
        document.getElementById('displayCallsign1').textContent = document.getElementById('callsign1').value;
        document.getElementById('displayCallsign2').textContent = document.getElementById('callsign2').value;
        document.getElementById('displaySubtitle1').textContent = document.getElementById('subtitle1').value;
        document.getElementById('displaySubtitle2').textContent = document.getElementById('subtitle2').value;
        document.getElementById('displayLocation').textContent = document.getElementById('location').value;
        document.getElementById('displayGrid').textContent = document.getElementById('grid').value;

        // Update table headers
        document.getElementById('displayHeaderDate').textContent = document.getElementById('headerDate').value;
        document.getElementById('displayHeaderMonth').textContent = document.getElementById('headerMonth').value;
        document.getElementById('displayHeaderDay').textContent = document.getElementById('headerDay').value;
        document.getElementById('displayHeaderUTC').textContent = document.getElementById('headerUTC').value;
        document.getElementById('displayHeaderBand').textContent = document.getElementById('headerBand').value;
        document.getElementById('displayHeaderRST').textContent = document.getElementById('headerRST').value;
        document.getElementById('displayHeaderMode').textContent = document.getElementById('headerMode').value;
        document.getElementById('displayHeaderQSL').textContent = document.getElementById('headerQSL').value;

        // Update other text
        document.getElementById('displayTextPSE').textContent = document.getElementById('textPSE').value;
        document.getElementById('displayTextTNX').textContent = document.getElementById('textTNX').value;
        document.getElementById('displayConfirmText').textContent = document.getElementById('confirmText').value;

        // Update font sizes display and apply
        const callsign1Size = document.getElementById('callsign1Size').value;
        const callsign2Size = document.getElementById('callsign2Size').value;
        document.getElementById('callsign1SizeValue').textContent = callsign1Size + 'mm';
        document.getElementById('callsign2SizeValue').textContent = callsign2Size + 'mm';
        document.getElementById('displayCallsign1').style.fontSize = callsign1Size + 'mm';
        document.getElementById('displayCallsign2').style.fontSize = callsign2Size + 'mm';

        // Update colors
        const textColor = document.getElementById('textColor').value;
        const cardBorderColor = document.getElementById('cardBorderColor').value;
        const overlayColorHex = document.getElementById('overlayColor').value;
        const opacity = document.getElementById('overlayOpacity').value / 100;
        document.getElementById('opacityValue').textContent = Math.round(opacity * 100) + '%'; // Update opacity display

        document.querySelector('.qsl-card').style.borderColor = cardBorderColor;
        document.querySelector('.qsl-card').style.backgroundColor = cardBorderColor;

        document.querySelectorAll('.callsign, .subtitle, .location, .grid').forEach(el => {
            el.style.color = textColor;
        });

        // Convert hex overlay color to rgba
        const r = parseInt(overlayColorHex.slice(1, 3), 16);
        const g = parseInt(overlayColorHex.slice(3, 5), 16);
        const b = parseInt(overlayColorHex.slice(5, 7), 16);
        const overlayRgba = `rgba(${r}, ${g}, ${b}, ${opacity})`;

        document.querySelector('.card-overlay').style.backgroundColor = overlayRgba;

        // Update fonts
        const cardFont = document.getElementById('cardFont').value;
        const qsoFont = document.getElementById('qsoFont').value;

        document.querySelectorAll('.callsign, .subtitle, .location, .grid').forEach(el => {
            el.style.fontFamily = cardFont;
        });

        document.querySelector('.qso-table').style.fontFamily = qsoFont;
        document.querySelectorAll('.qso-table input').forEach(input => {
            input.style.fontFamily = qsoFont;
        });

        // Update background image
        document.getElementById('cardContentArea').style.backgroundImage = currentBgImage ? `url(${currentBgImage})` : 'none';


    } catch (error) {
        console.error("Error updating display:", error);
    }
}

function loadLanguagePreset(language) {
    if (language === 'custom') {
        return; // Don't change settings if 'custom' is selected
    }
    const preset = languagePresets[language];
    if (!preset) {
        console.warn(`Language preset '${language}' not found.`);
        return;
    }

    console.log(`Loading preset: ${language}`);
    // Apply preset values to input fields
    Object.keys(preset).forEach(key => {
        const element = document.getElementById(key);
        if (element) {
            element.value = preset[key];
        } else {
            console.warn(`Element with ID '${key}' not found for preset loading.`);
        }
    });

    // Trigger updates after loading preset
    updateDisplayText();
}

function getCurrentSettings() {
    const settings = {};
    try {
        // Collect input values from settings panel
        document.querySelectorAll('#settingsPanel input, #settingsPanel select').forEach(input => {
            if (input.id && input.id !== 'bgImageFile' && input.id !== 'showOutlines' && input.type !== 'file') {
                settings[input.id] = input.value;
            }
        });

        // Store background image (if set)
        settings.backgroundImage = currentBgImage; // Use the global variable

        // Save positions
        settings.positions = {};
        document.querySelectorAll('.draggable').forEach(el => {
            settings.positions[el.id] = {
                left: el.style.left || null,
                top: el.style.top || null,
                right: el.style.right || null,
                bottom: el.style.bottom || null
            };
        });

        // Save QSO details
        settings.qsoDetails = {};
        document.querySelectorAll('.qso-table input').forEach(input => {
            if (input.name) {
                settings.qsoDetails[input.name] = input.type === 'checkbox' ? input.checked : input.value;
            }
        });

    } catch (error) {
        console.error("Error getting current settings:", error);
    }
    return settings;
}

function applySettings(settings) {
    if (!settings) {
        console.error("Attempted to apply null/undefined settings.");
        return;
    }
    console.log("Applying settings:", settings);

    try {
        // Apply settings to inputs
        Object.keys(settings).forEach(key => {
            const element = document.getElementById(key);
            if (element && key !== 'backgroundImage' && key !== 'positions' && key !== 'qsoDetails') {
                 if (element.type === 'range') {
                    element.value = settings[key];
                    // Trigger input event manually for range sliders to update display value
                    element.dispatchEvent(new Event('input'));
                 } else if (element.tagName === 'SELECT') {
                     element.value = settings[key];
                     // Trigger change event for selects
                     element.dispatchEvent(new Event('change'));
                 } else if (element.type !== 'file') {
                    element.value = settings[key];
                 }
            }
        });

        // Apply background image
        currentBgImage = settings.backgroundImage || null; // Update global variable
        document.getElementById('cardContentArea').style.backgroundImage = currentBgImage ? `url(${currentBgImage})` : 'none';
        // Clear the file input visually if background removed
        if (!currentBgImage) {
             document.getElementById('bgImageFile').value = '';
        }


        // Apply positions
        if (settings.positions) {
            Object.keys(settings.positions).forEach(id => {
                const el = document.getElementById(id);
                const pos = settings.positions[id];
                if (el && pos) {
                    // Clear all position styles first to avoid conflicts
                    el.style.left = el.style.top = el.style.right = el.style.bottom = '';
                    // Apply saved positions
                    if (pos.left !== null) el.style.left = pos.left;
                    if (pos.top !== null) el.style.top = pos.top;
                    if (pos.right !== null) el.style.right = pos.right;
                    if (pos.bottom !== null) el.style.bottom = pos.bottom;
                     // Fallback to default if no position saved (or if reset is desired)
                     if (pos.left === null && pos.top === null && pos.right === null && pos.bottom === null) {
                        resetElementPosition(el);
                    }
                } else if (el) {
                    // If position data is missing for an element, reset it
                     resetElementPosition(el);
                }
            });
        } else {
             // If no position data at all, reset all
            document.querySelectorAll('.draggable').forEach(resetElementPosition);
        }


        // Apply QSO details
        if (settings.qsoDetails) {
            Object.keys(settings.qsoDetails).forEach(name => {
                const input = document.querySelector(`.qso-table input[name="${name}"]`);
                if (input) {
                    if (input.type === 'checkbox') {
                        input.checked = settings.qsoDetails[name];
                    } else {
                        input.value = settings.qsoDetails[name];
                    }
                }
            });
        } else {
             // Clear QSO details if not in settings
             document.querySelectorAll('.qso-table input').forEach(input => {
                 if (input.type === 'checkbox') input.checked = false;
                 else input.value = '';
             });
        }


        // Final display update
        updateDisplayText();

        // Ensure language dropdown reflects loaded state (set to custom)
        document.getElementById('languageSelect').value = 'custom';

    } catch (error) {
        console.error("Error applying settings:", error);
        alert("An error occurred while applying settings. Please check console for details.");
    }
}

function resetElementPosition(el) {
     if (!el) return;
    // Reset to default positions from data attributes
    el.style.left = el.style.top = el.style.right = el.style.bottom = ''; // Clear existing inline styles first
    if (el.dataset.defaultLeft) el.style.left = el.dataset.defaultLeft;
    if (el.dataset.defaultTop) el.style.top = el.dataset.defaultTop;
    if (el.dataset.defaultRight) el.style.right = el.dataset.defaultRight;
    if (el.dataset.defaultBottom) el.style.bottom = el.dataset.defaultBottom;
}


// --- Draggable Functionality ---
function setupDraggable() {
    let activeElement = null;
    let initialX, initialY;
    let dragStartX, dragStartY; // Element's position at drag start

    const draggables = document.querySelectorAll('.draggable');
    const textContainer = document.querySelector('.text-container');
    const containerRect = textContainer.getBoundingClientRect(); // Get container bounds once

    function initializePositions() {
        // Attempt to load from localStorage first (applied in main DOMContentLoaded)
        // If no saved settings, apply defaults here
        const savedSettings = localStorage.getItem('qslCardSettings');
        if (!savedSettings) {
             draggables.forEach(resetElementPosition);
        } else {
            try {
                const settings = JSON.parse(savedSettings);
                if (!settings.positions) { // If saved settings exist but lack positions
                    draggables.forEach(resetElementPosition);
                }
                // Note: Actual position application happens in applySettings
            } catch (e) {
                 console.error("Error parsing saved settings for initial positions, resetting.", e);
                 draggables.forEach(resetElementPosition);
            }
        }
    }

    function dragStart(e) {
        if (!document.body.classList.contains('drag-mode')) return;

        const target = e.target.closest('.draggable');
        if (!target) return;

        e.preventDefault(); // Prevent text selection, etc.

        // Update container bounds in case of resize/scroll
        // containerRect = textContainer.getBoundingClientRect(); // Consider if needed dynamically

        activeElement = target;
        activeElement.classList.add('active');

        // Calculate starting position relative to the container
        const style = window.getComputedStyle(activeElement);
        // Use offsetLeft/Top which are relative to the offsetParent (textContainer)
        dragStartX = activeElement.offsetLeft;
        dragStartY = activeElement.offsetTop;

        initialX = (e.touches ? e.touches[0].clientX : e.clientX);
        initialY = (e.touches ? e.touches[0].clientY : e.clientY);

        // Clear right/bottom if they exist, as we'll drag using left/top
        activeElement.style.right = '';
        activeElement.style.bottom = '';

        document.addEventListener("mousemove", drag);
        document.addEventListener("mouseup", dragEnd);
        document.addEventListener("touchmove", drag, { passive: false });
        document.addEventListener("touchend", dragEnd);
    }

    function drag(e) {
        if (!activeElement) return;
        e.preventDefault();

        const currentX = (e.touches ? e.touches[0].clientX : e.clientX);
        const currentY = (e.touches ? e.touches[0].clientY : e.clientY);

        const dx = currentX - initialX;
        const dy = currentY - initialY;

        // Calculate new position
        let newLeft = dragStartX + dx;
        let newTop = dragStartY + dy;

        // Optional: Add boundary checks if needed
        // const elRect = activeElement.getBoundingClientRect();
        // newLeft = Math.max(0, Math.min(newLeft, containerRect.width - elRect.width));
        // newTop = Math.max(0, Math.min(newTop, containerRect.height - elRect.height));


        activeElement.style.left = newLeft + "px";
        activeElement.style.top = newTop + "px";
    }

    function dragEnd() {
        if (!activeElement) return;

        // Don't remove 'active' class immediately if controlled by checkbox/button
        // activeElement.classList.remove('active');
        // activeElement = null; // Keep activeElement reference for alignment buttons

        document.removeEventListener("mousemove", drag);
        document.removeEventListener("mouseup", dragEnd);
        document.removeEventListener("touchmove", drag);
        document.removeEventListener("touchend", dragEnd);
    }

    draggables.forEach(element => {
        element.addEventListener("mousedown", dragStart);
        element.addEventListener("touchstart", dragStart, { passive: false });
    });

    // Deselect on container click
    textContainer.addEventListener('click', (e) => {
        if (e.target === textContainer && document.body.classList.contains('drag-mode')) {
            document.querySelectorAll('.draggable.active').forEach(el => el.classList.remove('active'));
            activeElement = null;
        }
    });

    // --- Position Controls ---
    document.querySelectorAll('.position-action').forEach(button => {
        button.addEventListener('click', function() {
            if (!document.body.classList.contains('drag-mode')) return;

            const action = this.dataset.action;
            const targetElements = activeElement ? [activeElement] : Array.from(draggables);

            targetElements.forEach(el => {
                 // Convert mm defaults to px for calculations if needed, or use %
                const container = el.closest('.text-container');
                if (!container) return;
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;
                const elWidth = el.offsetWidth;
                const elHeight = el.offsetHeight;
                const padding = 3; // Rough padding in mm, convert as needed or use px

                // Clear conflicting styles before applying new ones
                if (action.includes('Left') || action.includes('Center') || action.includes('Right') || action === 'reset') {
                   el.style.right = '';
                }
                if (action.includes('Top') || action.includes('Middle') || action.includes('Bottom') || action === 'reset') {
                    el.style.bottom = '';
                }
                if (action !== 'reset'){
                   el.style.left = ''; // Clear left unless setting left/center
                   el.style.top = ''; // Clear top unless setting top/middle
                }


                switch (action) {
                    case 'alignLeft':   el.style.left = `${padding}mm`; break;
                    case 'alignCenter': el.style.left = `${(containerWidth - elWidth) / 2}px`; break;
                    case 'alignRight':  el.style.left = `${containerWidth - elWidth - (padding * 3.78)}px`; break; // Approx mm to px
                    case 'alignTop':    el.style.top = `${padding}mm`; break;
                    case 'alignMiddle': el.style.top = `${(containerHeight - elHeight) / 2}px`; break;
                    case 'alignBottom': el.style.top = `${containerHeight - elHeight - (padding * 3.78)}px`; break;
                    case 'reset':       resetElementPosition(el); break;
                }
            });
        });
    });

    // Toggle Drag Mode Button
    document.getElementById('toggleDraggableBtn').addEventListener('click', function() {
        const isDragMode = document.body.classList.toggle('drag-mode');
        this.textContent = isDragMode ? 'Disable Drag Mode' : 'Enable Drag Mode';
        document.getElementById('positionControls').style.display = isDragMode ? 'block' : 'none';
        const showOutlinesCheckbox = document.getElementById('showOutlines');

        if (isDragMode) {
            // Apply outline based on checkbox state
            if (showOutlinesCheckbox.checked) {
                draggables.forEach(el => el.classList.add('draggable-visible'));
            }
        } else {
            // Remove outlines and active state when disabling drag mode
            draggables.forEach(el => {
                el.classList.remove('draggable-visible', 'active');
            });
            activeElement = null;
        }
    });

    // Show Outlines Checkbox
    document.getElementById('showOutlines').addEventListener('change', function() {
        if (document.body.classList.contains('drag-mode')) {
            if (this.checked) {
                draggables.forEach(el => el.classList.add('draggable-visible'));
            } else {
                // Only remove if not currently the active dragging element
                draggables.forEach(el => {
                     if (!el.classList.contains('active')) {
                         el.classList.remove('draggable-visible');
                     }
                });
            }
        }
    });

    // Initialize
    initializePositions();
}


// --- Event Listeners ---
document.addEventListener('DOMContentLoaded', function() {

    // --- Initial Setup ---
    const settingsPanel = document.getElementById('settingsPanel');
    const qslCard = document.querySelector('.qsl-card');
    const settingsFileInput = document.getElementById('settingsFileInput');

    // Setup input change listeners to update display
    document.querySelectorAll('#settingsPanel input, #settingsPanel select').forEach(input => {
        input.addEventListener('input', updateDisplayText);
        // Special case for color inputs using 'change' event for better compatibility
        if (input.type === 'color') {
             input.addEventListener('change', updateDisplayText);
        }
        // Update display on select change too
        if (input.tagName === 'SELECT') {
            input.addEventListener('change', updateDisplayText);
        }
    });

    // Language selector change
    document.getElementById('languageSelect').addEventListener('change', function() {
        loadLanguagePreset(this.value);
    });

    // --- Background Image Handling ---
    document.getElementById('updateBgBtn').addEventListener('click', () => {
        const fileInput = document.getElementById('bgImageFile');
        if (fileInput.files && fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                currentBgImage = e.target.result; // Store in global variable
                updateDisplayText(); // Update card display
            };
            reader.onerror = (e) => {
                 console.error("FileReader error:", e);
                 alert("Error reading image file.");
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            alert('Please select an image file first.');
        }
    });

     document.getElementById('removeBgBtn').addEventListener('click', () => {
        currentBgImage = null; // Clear global variable
        document.getElementById('bgImageFile').value = ''; // Clear file input
        updateDisplayText(); // Update card display
    });

    // --- Settings Save/Load ---
    document.getElementById('saveSettingsBtn').addEventListener('click', function() {
        const settings = getCurrentSettings();
        const settingsJson = JSON.stringify(settings, null, 2); // Pretty print JSON

        try {
            localStorage.setItem('qslCardSettings', settingsJson);
            alert('Settings saved to browser storage!');
        } catch (e) {
            console.error('Error saving settings to localStorage:', e);
            alert('Error saving settings to browser storage. It might be full. Consider saving to a file.');
        }
    });

     // "Save as File" Button
    document.getElementById('saveAsBtn').addEventListener('click', function() {
        const settings = getCurrentSettings();
        const settingsJson = JSON.stringify(settings, null, 2);
        const blob = new Blob([settingsJson], { type: 'application/json;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        // Generate a filename (e.g., based on callsign)
        const filename = `QSL_Settings_${settings.callsign1 || 'Custom'}.json`;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });


    // "Load Settings (File)" Button - Triggers the hidden file input
    document.getElementById('loadSettingsBtn').addEventListener('click', function() {
        settingsFileInput.click(); // Trigger the actual file input
    });

    // Hidden File Input Change Event - Handles loading from file
    settingsFileInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const settings = JSON.parse(event.target.result);
                    applySettings(settings); // Apply the loaded settings
                    alert(`Settings loaded successfully from ${file.name}!`);
                } catch (err) {
                    console.error('Error parsing settings file:', err);
                    alert(`Error loading settings from ${file.name}. The file might be corrupted or invalid.`);
                } finally {
                     // Reset file input value to allow loading the same file again
                     e.target.value = null;
                }
            };
             reader.onerror = (err) => {
                console.error("FileReader error:", err);
                alert(`Error reading file ${file.name}.`);
                e.target.value = null; // Reset file input
            };
            reader.readAsText(file);
        }
    });


    // --- Reset Button ---
    document.getElementById('resetBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to reset ALL settings and QSO data to the default English layout?')) {
            // Reset language preset to English (this updates many text fields)
            loadLanguagePreset('en');
            document.getElementById('languageSelect').value = 'en'; // Set dropdown

            // Reset colors and opacity
            document.getElementById('cardBorderColor').value = '#1a4e8c';
            document.getElementById('textColor').value = '#E6B800';
            document.getElementById('overlayColor').value = '#1a7bcd';
            document.getElementById('overlayOpacity').value = 30;

            // Reset font sizes
            document.getElementById('callsign1Size').value = 16;
            document.getElementById('callsign2Size').value = 16;

            // Reset fonts
            document.getElementById('cardFont').value = 'Arial, sans-serif';
            document.getElementById('qsoFont').value = 'Arial, sans-serif';

            // Reset background image
            currentBgImage = null;
            document.getElementById('bgImageFile').value = '';

            // Reset positions
            document.querySelectorAll('.draggable').forEach(resetElementPosition);

            // Reset QSO details in the table
            document.querySelectorAll('.qso-table input').forEach(input => {
                 if (input.type === 'checkbox') input.checked = false;
                 else input.value = '';
            });

            // Disable drag mode if active
            if (document.body.classList.contains('drag-mode')) {
                document.getElementById('toggleDraggableBtn').click();
            }

            // Clear local storage
            localStorage.removeItem('qslCardSettings');
            localStorage.removeItem('qslCardBackground'); // Kept separate before, remove too

            // Final display update
            updateDisplayText();
            alert("Settings reset to default.");
        }
    });

    // --- Print Button ---
     document.getElementById('printBtn').addEventListener('click', function() {
    // First disable drag mode if it's active
    if (document.body.classList.contains('drag-mode')) {
        document.getElementById('toggleDraggableBtn').click();
    }
    
    const cardContent = document.querySelector('.card-content');
    const currentBgImage = cardContent.style.backgroundImage;
    const overlay = document.querySelector('.card-overlay');
    const currentOpacity = overlay.style.backgroundColor;
    
    // Get the current text color
    const currentTextColor = document.getElementById('textColor').value;
    
    // Apply the current background image and text color directly for printing
    const style = document.createElement('style');
  // In the print button handler, fix the media query:
style.textContent = `
    @media print {
        #displayCallsign1 {
            font-size: ${document.getElementById('callsign1Size').value}mm !important;
        }
        #displayCallsign2 {
            font-size: ${document.getElementById('callsign2Size').value}mm !important;
        }
        
        .card-content {
            background-image: ${currentBgImage || 'none'} !important;
        }
        .card-overlay {
            background-color: ${currentOpacity || 'rgba(26, 123, 205, 0.3)'} !important;
        }
        .callsign, .subtitle, .location, .grid {
            color: ${currentTextColor} !important;
            text-shadow: 1mm 1mm 2mm rgba(0, 0, 0, 0.7) !important;
        }
    }
`;
`;
    `;
    document.head.appendChild(style);
    
    setTimeout(() => {
        try {
            window.print();
        } catch (e) {
            console.error("Print error:", e);
            alert("Print functionality not available. Please use your browser's print function (Ctrl+P or Cmd+P).");
        }
    }, 100);
});;

     // --- Settings Panel Toggle ---
    document.getElementById('toggleSettings').addEventListener('click', function() {
        const settingsPanel = document.getElementById('settingsPanel');
        const isHidden = settingsPanel.style.display === 'none';
        if (isHidden) {
            settingsPanel.style.display = 'block';
            this.textContent = 'Hide Settings';
        } else {
            settingsPanel.style.display = 'none';
            this.textContent = 'Show Settings';
        }
    });


    // --- Initialize Draggable ---
    setupDraggable();

    // --- Load Initial State ---
    const savedSettings = localStorage.getItem('qslCardSettings');
    if (savedSettings) {
        console.log("Found saved settings in localStorage.");
        try {
            const settings = JSON.parse(savedSettings);
            applySettings(settings);
            // If background was stored separately (old method), load it too
            const savedBg = localStorage.getItem('qslCardBackground');
             if (savedBg && !settings.backgroundImage) { // Only if not already in main settings
                currentBgImage = savedBg;
            }
        } catch (e) {
            console.error('Error parsing saved settings from localStorage on load:', e);
            localStorage.removeItem('qslCardSettings'); // Clear corrupted data
            loadLanguagePreset('en'); // Load default if parsing fails
        }
    } else {
        console.log("No saved settings found, loading default (English).");
        loadLanguagePreset('en'); // Load default English preset if no settings saved
    }

    // Final initial display update
    updateDisplayText();

});
</script>
</body>
</html>
