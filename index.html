<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customizable QSL Card - Standard 140x90mm Size</title>
<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background-color: #f0f0f0;
    text-align: left;
}
.container {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
}
.settings-panel {
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 5mm;
    padding: 15px;
    margin-bottom: 20px;
}
.settings-section {
    margin-bottom: 10px;
}
.settings-title {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 10px;
    color: #1a4e8c;
}
.settings-subtitle {
    font-size: 14px;
    font-weight: bold;
    margin: 10px 0 5px;
    color: #555;
}
.form-group {
    margin-bottom: 8px;
    display: flex;
    align-items: center;
}
.form-group label {
    width: 120px;
    font-size: 14px;
}
.form-group input, .form-group select {
    flex: 1;
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 3px;
}
.settings-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 10px;
}
.settings-col {
    flex: 1;
    min-width: 250px;
}
/* QSL Card Styles */
.qsl-card {
    width: 140mm;
    height: 90mm;
    margin: 0 auto 5mm;
    border: 2px solid #1a4e8c;
    background-color: #1a4e8c;
    padding: 3mm;
    border-radius: 3mm;
    box-sizing: border-box;
    overflow: hidden;
}
.inner-card {
    background-color: white;
    padding: 2mm;
    border-radius: 2mm;
    height: 100%;
    box-sizing: border-box;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}
.card-content {
    background-color: transparent;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-blend-mode: normal;
    color: gold;
    padding: 3mm;
    position: relative;
    /* Optimized height for image */
    height: 65mm;
    border: 0.5mm solid #ccc;
    box-sizing: border-box;
    overflow: hidden;
    border-radius: 2mm;
    margin-bottom: 1mm;
}
.card-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(26, 123, 205, 0.3);
    padding: 3mm;
    border-radius: 2mm;
}
.text-container {
    position: relative;
    z-index: 10;
    height: 100%;
    width: 100%;
	
	/* Add this CSS to increase specificity */
.text-container .callsign#displayCallsign1,
.text-container .callsign#displayCallsign2 {
    font-size: 16mm; /* Default size that will be overridden */
}
}
/* Make text elements draggable */
.draggable {
    position: absolute;
    cursor: move;
    user-select: none;
    -webkit-user-select: none;
    padding: 2px;
    z-index: 20;
}
.drag-mode .draggable:hover {
    outline: 1px dashed rgba(255, 255, 255, 0.5);
}
.draggable.active {
    outline: 2px solid rgba(255, 255, 255, 0.8);
}
.draggable-visible {
    outline: 1px dashed rgba(255, 255, 255, 0.5);
}
.callsign {
    font-size: 16mm;
    font-weight: bold;
    margin-bottom: 1mm;
    color: #E6B800;
    text-shadow: 1mm 1mm 2mm rgba(0, 0, 0, 0.7);
}
.subtitle {
    font-size: 5mm;
    margin-bottom: 1mm;
    color: #E6B800;
    text-shadow: 1mm 1mm 2mm rgba(0, 0, 0, 0.7);
}
.location {
    font-size: 5mm;
    text-align: right;
    color: #E6B800;
    text-shadow: 1mm 1mm 2mm rgba(0, 0, 0, 0.7);
}
.grid {
    font-size: 5mm;
    text-align: right;
    color: #E6B800;
    text-shadow: 1mm 1mm 2mm rgba(0, 0, 0, 0.7);
}
/* Compact QSO Data Table */
.qso-table {
    width: 100%;
    border-collapse: collapse;
    margin: 0;
    padding: 0;
    font-size: 2.7mm;
    height: 16mm;
    flex-grow: 1;
}
.qso-table td, .qso-table th {
    border: 0.2mm solid black;
    padding: 0.8mm 0.2mm;
    text-align: center;
    vertical-align: middle;
    height: auto;
}
.qso-table input[type="text"] {
    width: 95%;
    height: 4.5mm;
    padding: 0.3mm;
    box-sizing: border-box;
    font-size: 3mm;
    text-align: center;
}
.confirm-row {
    height: 5mm;
}
.confirm-row input {
    width: 95%;
    height: 4mm;
    margin: 0;
    font-size: 3mm;
    text-align: center;
}
.confirm-text {
    font-size: 2.7mm;
    margin-right: 1mm;
}
.qsl-checkbox-cell {
    vertical-align: middle;
    width: 8%;
}
.checkbox-container {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    align-items: center;
    height: 100%;
    font-size: 2.5mm;
}
.checkbox-container div {
    display: flex;
    align-items: center;
    white-space: nowrap;
    margin: 0.2mm 0;
}
.checkbox-container input[type="checkbox"] {
    transform: scale(0.7);
    margin: 0 0 0 0.5mm;
    vertical-align: middle;
}
.action-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
}
.action-button {
    padding: 8px 15px;
    background-color: #1a4e8c;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    min-width: 100px;
}
.action-button:hover {
    background-color: #15407a;
}
.action-button.secondary {
    background-color: #777;
}
.action-button.secondary:hover {
    background-color: #666;
}
.language-selector {
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}
.language-selector select {
    padding: 6px;
    border-radius: 4px;
    border: 1px solid #ccc;
}
.collapse-button {
    background-color: #ddd;
    color: #333;
    border: none;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 14px;
    border-radius: 3px;
    margin-right: 10px;
}
/* Position controls */
.position-controls {
    display: none;
    margin-top: 10px;
    padding: 10px;
    background-color: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 5px;
}
.position-controls-title {
    font-weight: bold;
    margin-bottom: 5px;
}
.position-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}
.position-action {
    padding: 5px 10px;
    background-color: #ddd;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
}
.position-checkbox {
    margin-top: 10px;
}
@media print {
    body {
        padding: 0;
        margin: 0;
        background: none;
    }
    .settings-panel, .action-buttons, .language-selector, .collapse-button, .position-controls {
        display: none !important;
    }
    .qsl-card {
        width: 140mm;
        height: 90mm;
        margin: 0;
        padding: 3mm;
        border: 2px solid #1a4e8c !important;
        background-color: #1a4e8c !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
        box-sizing: border-box;
        overflow: hidden;
    }
    .inner-card {
        background-color: white !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
    .card-content {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
    .card-overlay {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
    .callsign, .subtitle, .location, .grid {
        color: #E6B800 !important;
        text-shadow: 1mm 1mm 2mm rgba(0, 0, 0, 0.7) !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
    @page {
        size: 140mm 90mm;
        margin: 0;
    }
}
</style>
</head>
<body>
<div class="container">
    <div class="language-selector">
        <button id="toggleSettings" class="collapse-button">Hide Settings</button>
        <label for="languageSelect">Language:</label>
        <select id="languageSelect">
            <option value="en">English</option>
            <option value="de">German (Deutsch)</option>
            <option value="fr">French (Français)</option>
            <option value="es">Spanish (Español)</option>
            <option value="custom">Custom</option>
        </select>
        <button id="saveSettingsBtn" class="action-button secondary">Save Settings</button>
        <button id="loadSettingsBtn" class="action-button secondary">Load Settings</button>
    </div>
    
    <div id="settingsPanel" class="settings-panel">
        <div class="settings-title">QSL Card Customization</div>
        
        <div class="settings-row">
            <div class="settings-col">
             


			   <div class="settings-subtitle">Callsign Information</div>
                <div class="form-group">
                    <label for="callsign1">Callsign 1:</label>
                    <input type="text" id="callsign1" value="DJOCU">
                </div>
                <div class="form-group">
                    <label for="callsign2">Callsign 2:</label>
                    <input type="text" id="callsign2" value="G4ADF">
                </div>
                <div class="form-group">
                    <label for="subtitle1">Subtitle 1:</label>
                    <input type="text" id="subtitle1" value="DOK M08">
                </div>
                <div class="form-group">
                    <label for="subtitle2">Subtitle 2:</label>
                    <input type="text" id="subtitle2" value="72/73 de Paul">
                </div>
                <div class="form-group">
                    <label for="location">Location:</label>
                    <input type="text" id="location" value="Fehmarn, Germany">
                </div>
                <div class="form-group">
                    <label for="grid">Grid:</label>
                    <input type="text" id="grid" value="JO54OK">
                </div>
            </div>
            
            <div class="settings-col">
                <div class="settings-subtitle">Table Headers</div>
                <div class="form-group">
                    <label for="headerDate">Date:</label>
                    <input type="text" id="headerDate" value="Date">
                </div>
                <div class="form-group">
                    <label for="headerMonth">Month:</label>
                    <input type="text" id="headerMonth" value="Month">
                </div>
                <div class="form-group">
                    <label for="headerDay">Day:</label>
                    <input type="text" id="headerDay" value="Day">
                </div>
                <div class="form-group">
                    <label for="headerUTC">UTC:</label>
                    <input type="text" id="headerUTC" value="UTC">
                </div>
                <div class="form-group">
                    <label for="headerBand">Band:</label>
                    <input type="text" id="headerBand" value="Band">
                </div>
                <div class="form-group">
                    <label for="headerRST">RST:</label>
                    <input type="text" id="headerRST" value="RST">
                </div>
                <div class="form-group">
                    <label for="headerMode">Mode:</label>
                    <input type="text" id="headerMode" value="Mode">
                </div>
                <div class="form-group">
                    <label for="headerQSL">QSL:</label>
                    <input type="text" id="headerQSL" value="QSL?">
                </div>
            </div>
            
            <div class="settings-col">
                <div class="settings-subtitle">QSL Options & Text</div>
                <div class="form-group">
                    <label for="textPSE">PSE Text:</label>
                    <input type="text" id="textPSE" value="PSE">
                </div>
                <div class="form-group">
                    <label for="textTNX">TNX Text:</label>
                    <input type="text" id="textTNX" value="TNX">
                </div>
                <div class="form-group">
                    <label for="confirmText">Confirm Text:</label>
                    <input type="text" id="confirmText" value="Confirm QSO with:">
                </div>
                
                <div class="settings-subtitle">Colors</div>
                <div class="form-group">
                    <label for="cardBorderColor">Card Border:</label>
                    <input type="color" id="cardBorderColor" value="#1a4e8c">
                </div>
                <div class="form-group">
                    <label for="textColor">Text Color:</label>
                    <input type="color" id="textColor" value="#E6B800">
                </div>
                <div class="form-group">
                    <label for="overlayColor">Overlay Color:</label>
                    <input type="color" id="overlayColor" value="#1a7bcd">
                </div>
                
                <!-- Font selection controls -->
                <div class="settings-subtitle">Fonts</div>
                <div class="form-group">
                    <label for="cardFont">Card Font:</label>
                    <select id="cardFont">
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="'Courier New', monospace">Courier New</option>
                        <option value="Georgia, serif">Georgia</option>
                        <option value="'Times New Roman', serif">Times New Roman</option>
                        <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                        <option value="Verdana, sans-serif">Verdana</option>
                        <option value="Impact, sans-serif">Impact</option>
                        <option value="'Arial Black', sans-serif">Arial Black</option>
                        <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="qsoFont">QSO Details Font:</label>
                    <select id="qsoFont">
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="'Courier New', monospace">Courier New</option>
                        <option value="Georgia, serif">Georgia</option>
                        <option value="'Times New Roman', serif">Times New Roman</option>
                        <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                        <option value="Verdana, sans-serif">Verdana</option>
                        <option value="'Lucida Console', monospace">Lucida Console</option>
                    </select>
                </div>
          
<!-- Add this to the settings panel, in the Fonts section -->
<div class="settings-subtitle">Font Sizes</div>
<div class="form-group">
    <label for="callsign1Size">Callsign 1 Size:</label>
    <input type="range" id="callsign1Size" min="8" max="24" value="16" step="1">
    <span id="callsign1SizeValue">16mm</span>
</div>
<div class="form-group">
    <label for="callsign2Size">Callsign 2 Size:</label>
    <input type="range" id="callsign2Size" min="8" max="24" value="16" step="1">
    <span id="callsign2SizeValue">16mm</span>
</div>  



		  </div>
        </div>
        
        <div class="settings-section">
            <div class="settings-subtitle">Background Image</div>
            <div class="form-group">
                <label for="bgImageFile">Image:</label>
                <input type="file" id="bgImageFile" accept="image/*">
                <button id="updateBgBtn" class="action-button secondary">Update Background</button>
            </div>
            <div class="form-group">
                <label for="overlayOpacity">Overlay Opacity:</label>
                <input type="range" id="overlayOpacity" min="0" max="100" value="30" step="1">
                <span id="opacityValue">30%</span>
            </div>
        </div>

        <!-- Position Controls Section -->
        <div class="settings-section">
            <div class="settings-subtitle">Text Position</div>
            <div class="form-group">
                <label>Positioning:</label>
                <button id="toggleDraggableBtn" class="action-button secondary">Enable Drag Mode</button>
            </div>
            <div id="positionControls" class="position-controls">
                <div class="position-controls-title">Position Controls</div>
                <div class="position-buttons">
                    <button class="position-action" data-action="alignLeft">Align Left</button>
                    <button class="position-action" data-action="alignCenter">Align Center</button>
                    <button class="position-action" data-action="alignRight">Align Right</button>
                    <button class="position-action" data-action="alignTop">Align Top</button>
                    <button class="position-action" data-action="alignMiddle">Align Middle</button>
                    <button class="position-action" data-action="alignBottom">Align Bottom</button>
                    <button class="position-action" data-action="reset">Reset Positions</button>
                </div>
                <div class="position-checkbox">
                    <label>
                        <input type="checkbox" id="showOutlines"> Show text element outlines
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <div class="qsl-card">
        <div class="inner-card">
            <div class="card-content">
                <div class="card-overlay">
                    <div class="text-container">
                        <div class="callsign draggable" id="displayCallsign1" data-default-left="3mm" data-default-top="3mm">DJOCU</div>
                        <div class="callsign draggable" id="displayCallsign2" data-default-left="3mm" data-default-top="20mm">G4ADF</div>
                        <div class="subtitle draggable" id="displaySubtitle1" data-default-left="3mm" data-default-top="40mm">DOK M08</div>
                        <div class="subtitle draggable" id="displaySubtitle2" data-default-left="3mm" data-default-top="47mm">72/73 de Paul</div>
                        <div class="location draggable" id="displayLocation" data-default-right="3mm" data-default-bottom="10mm">Fehmarn, Germany</div>
                        <div class="grid draggable" id="displayGrid" data-default-right="3mm" data-default-bottom="3mm">JO54OK</div>
                    </div>
                </div>
            </div>
            <table class="qso-table">
                <tr>
                    <th id="displayHeaderDate">Date</th>
                    <th id="displayHeaderMonth">Month</th>
                    <th id="displayHeaderDay">Day</th>
                    <th id="displayHeaderUTC">UTC</th>
                    <th id="displayHeaderBand">Band</th>
                    <th id="displayHeaderRST">RST</th>
                    <th id="displayHeaderMode">Mode</th>
                    <th id="displayHeaderQSL">QSL?</th>
                </tr>
                <tr>
                    <td><input type="text" name="date"></td>
                    <td><input type="text" name="month"></td>
                    <td><input type="text" name="day"></td>
                    <td><input type="text" name="utc"></td>
                    <td><input type="text" name="band"></td>
                    <td><input type="text" name="rst"></td>
                    <td><input type="text" name="mode"></td>
                    <td class="qsl-checkbox-cell">
                        <div class="checkbox-container">
                            <div><span id="displayTextPSE">PSE</span> <input type="checkbox" name="pse"></div>
                            <div><span id="displayTextTNX">TNX</span> <input type="checkbox" name="tnx"></div>
                        </div>
                    </td>
                </tr>
                <tr class="confirm-row">
                    <td colspan="7"><span class="confirm-text" id="displayConfirmText">Confirm QSO with:</span> <input type="text" name="qso_with"></td>
                    <td></td>
                </tr>
            </table>
        </div>
    </div>
    
    <div class="action-buttons">
        <button id="printBtn" class="action-button">Print QSL Card</button>
        <button id="saveAsBtn" class="action-button">Save as File</button>
        <button id="resetBtn" class="action-button secondary">Reset to Default</button>
    </div>
</div>

<script>
// Language Presets
const languagePresets = {
    en: {
        callsign1: "A8ABC",
        callsign2: "A8ABD",
        subtitle1: "DOK XYZ",
        subtitle2: "72/73 de Paul",
        location: "Germany",
        grid: "AB01DE",
        headerDate: "Date",
        headerMonth: "Month",
        headerDay: "Day",
        headerUTC: "UTC",
        headerBand: "Band",
        headerRST: "RST",
        headerMode: "Mode",
        headerQSL: "QSL?",
        textPSE: "PSE",
        textTNX: "TNX",
        confirmText: "Confirm QSO with:"
    },
    de: {
        callsign1: "A8ABC",
        callsign2: "A8ABD",
        subtitle1: "DOK XYZ",
        subtitle2: "72/73 de Paul",
        location: "Germany",
        headerDate: "Datum",
        headerMonth: "Monat",
        headerDay: "Tag",
        headerUTC: "UTC",
        headerBand: "Band",
        headerRST: "RST",
        headerMode: "Mode",
        headerQSL: "QSL?",
        textPSE: "BITTE",
        textTNX: "DANKE",
        confirmText: "Bestätigung QSO mit:"
    },
    fr: {
        callsign1: "A8ABC",
        callsign2: "A8ABD",
        subtitle1: "DOK XYZ",
        subtitle2: "72/73 de Paul",
        location: "Allemagne",
        grid: "JO54OK",
        headerDate: "Date",
        headerMonth: "Mois",
        headerDay: "Jour",
        headerUTC: "UTC",
        headerBand: "Bande",
        headerRST: "RST",
        headerMode: "Mode",
        headerQSL: "QSL?",
        textPSE: "SVP",
        textTNX: "MERCI",
        confirmText: "Confirmer QSO avec:"
    },
    es: {
        callsign1: "A8ABC",
        callsign2: "A8ABD",
        subtitle1: "DOK XYZ",
        subtitle2: "72/73 de Paul",
        location: "Alemania",
        grid: "JO54OK",
        headerDate: "Fecha",
        headerMonth: "Mes",
        headerDay: "Día",
        headerUTC: "UTC",
        headerBand: "Banda",
        headerRST: "RST",
        headerMode: "Modo",
        headerQSL: "QSL?",
        textPSE: "POR FAVOR",
        textTNX: "GRACIAS",
        confirmText: "Confirmar QSO con:"
    }
};

// Utility Functions
function updateDisplayText() {
    // Update all display text elements based on input values
    document.getElementById('displayCallsign1').textContent = document.getElementById('callsign1').value;
    document.getElementById('displayCallsign2').textContent = document.getElementById('callsign2').value;
    document.getElementById('displaySubtitle1').textContent = document.getElementById('subtitle1').value;
    document.getElementById('displaySubtitle2').textContent = document.getElementById('subtitle2').value;
    document.getElementById('displayLocation').textContent = document.getElementById('location').value;
    document.getElementById('displayGrid').textContent = document.getElementById('grid').value;
    
    document.getElementById('displayHeaderDate').textContent = document.getElementById('headerDate').value;
    document.getElementById('displayHeaderMonth').textContent = document.getElementById('headerMonth').value;
    document.getElementById('displayHeaderDay').textContent = document.getElementById('headerDay').value;
    document.getElementById('displayHeaderUTC').textContent = document.getElementById('headerUTC').value;
    document.getElementById('displayHeaderBand').textContent = document.getElementById('headerBand').value;
    document.getElementById('displayHeaderRST').textContent = document.getElementById('headerRST').value;
    document.getElementById('displayHeaderMode').textContent = document.getElementById('headerMode').value;
    document.getElementById('displayHeaderQSL').textContent = document.getElementById('headerQSL').value;
    
    document.getElementById('displayTextPSE').textContent = document.getElementById('textPSE').value;
    document.getElementById('displayTextTNX').textContent = document.getElementById('textTNX').value;
    document.getElementById('displayConfirmText').textContent = document.getElementById('confirmText').value;
	const callsign1Size = document.getElementById('callsign1Size').value;
const callsign2Size = document.getElementById('callsign2Size').value;
document.getElementById('callsign1SizeValue').textContent = callsign1Size + 'mm';
document.getElementById('callsign2SizeValue').textContent = callsign2Size + 'mm';

// Apply font sizes to callsigns
document.getElementById('displayCallsign1').style.fontSize = callsign1Size + 'mm';
document.getElementById('displayCallsign2').style.fontSize = callsign2Size + 'mm';
    
    // Update colors
    const textColor = document.getElementById('textColor').value;
    const cardBorderColor = document.getElementById('cardBorderColor').value;
    const overlayColor = document.getElementById('overlayColor').value;
    const opacity = document.getElementById('overlayOpacity').value / 100;
    
    document.querySelector('.qsl-card').style.borderColor = cardBorderColor;
    document.querySelector('.qsl-card').style.backgroundColor = cardBorderColor;
    
    document.querySelectorAll('.callsign, .subtitle, .location, .grid').forEach(el => {
        el.style.color = textColor;
    });
    
    // Convert hex to rgba for overlay
    const r = parseInt(overlayColor.slice(1, 3), 16);
    const g = parseInt(overlayColor.slice(3, 5), 16);
    const b = parseInt(overlayColor.slice(5, 7), 16);
    
    // Handle opacity - set to fully transparent if 0
    if (parseInt(document.getElementById('overlayOpacity').value) === 0) {
        document.querySelector('.card-overlay').style.backgroundColor = 'transparent';
    } else {
        document.querySelector('.card-overlay').style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${opacity})`;
    }
    
    // Update fonts
    const cardFont = document.getElementById('cardFont').value;
    const qsoFont = document.getElementById('qsoFont').value;
    
    document.querySelectorAll('.callsign, .subtitle, .location, .grid').forEach(el => {
        el.style.fontFamily = cardFont;
    });
    
    document.querySelector('.qso-table').style.fontFamily = qsoFont;
    document.querySelectorAll('.qso-table input').forEach(input => {
        input.style.fontFamily = qsoFont;
    });
}

function loadLanguagePreset(language) {
    if (language === 'custom') {
        return; // Don't change anything for custom selection
    }
    
    const preset = languagePresets[language];
    if (!preset) return;
    
    // Apply preset values to all input fields
    Object.keys(preset).forEach(key => {
        if (document.getElementById(key)) {
            document.getElementById(key).value = preset[key];
        }
    });
    
    // Update display
    updateDisplayText();
}

function getCurrentSettings() {
    const settings = {};
    
    // Collect all input values
    document.querySelectorAll('#settingsPanel input, #settingsPanel select').forEach(input => {
        if (input.id && input.id !== 'bgImageFile' && input.id !== 'showOutlines') {
            settings[input.id] = input.value;
        }
    });
    
    // Include background image if available
    if (localStorage.getItem('qslCardBackground')) {
        settings.backgroundImage = localStorage.getItem('qslCardBackground');
    }
    
    // Save positions of all draggable elements
    const positions = {};
    document.querySelectorAll('.draggable').forEach(el => {
        positions[el.id] = {
            left: el.style.left || null,
            top: el.style.top || null,
            right: el.style.right || null,
            bottom: el.style.bottom || null
        };
    });
    settings.positions = positions;
    
    // Save QSO details from the table inputs
    const qsoDetails = {};
    document.querySelectorAll('.qso-table input[type="text"]').forEach(input => {
        qsoDetails[input.name] = input.value;
    });
    
    // Save checkbox states
    document.querySelectorAll('.qso-table input[type="checkbox"]').forEach(checkbox => {
        qsoDetails[checkbox.name] = checkbox.checked;
    });
    
    settings.qsoDetails = qsoDetails;
    
    return settings;
}

function applySettings(settings) {
    if (!settings) return;
    
    // Apply all settings to inputs
    Object.keys(settings).forEach(key => {
        if (document.getElementById(key) && key !== 'backgroundImage' && key !== 'positions' && key !== 'qsoDetails') {
            document.getElementById(key).value = settings[key];
        }
    });
    
    // Apply background image if available
    if (settings.backgroundImage) {
        localStorage.setItem('qslCardBackground', settings.backgroundImage);
        document.querySelector('.card-content').style.backgroundImage = `url(${settings.backgroundImage})`;
    }
    
    // Apply saved positions
    if (settings.positions) {
        Object.keys(settings.positions).forEach(id => {
            const el = document.getElementById(id);
            const pos = settings.positions[id];
            if (el && pos) {
                if (pos.left) el.style.left = pos.left;
                if (pos.top) el.style.top = pos.top;
                if (pos.right) el.style.right = pos.right;
                if (pos.bottom) el.style.bottom = pos.bottom;
            }
        });
    }
    
    // Apply QSO details if available
    if (settings.qsoDetails) {
        // Apply text inputs
        Object.keys(settings.qsoDetails).forEach(name => {
            const input = document.querySelector(`.qso-table input[name="${name}"]`);
            if (input) {
                if (input.type === 'text') {
                    input.value = settings.qsoDetails[name];
                } else if (input.type === 'checkbox') {
                    input.checked = settings.qsoDetails[name];
                }
            }
        });
    }
    
    // Update display
    updateDisplayText();
}

// Main Draggable Functionality
function setupDraggable() {
    let activeElement = null;
    let initialX, initialY;
    let currentX, currentY;
    let xOffset = 0;
    let yOffset = 0;

    // Get all draggable elements
    const draggables = document.querySelectorAll('.draggable');
    
    // Set initial positions based on data attributes
    function initializePositions() {
        draggables.forEach(el => {
            // Check if we have saved positions in localStorage
            const savedSettings = localStorage.getItem('qslCardSettings');
            let positions = null;
            
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    positions = settings.positions ? settings.positions[el.id] : null;
                } catch (e) {
                    console.error('Error parsing saved positions:', e);
                }
            }
            
            if (positions) {
                // Apply saved positions
                if (positions.left) el.style.left = positions.left;
                if (positions.top) el.style.top = positions.top;
                if (positions.right) el.style.right = positions.right;
                if (positions.bottom) el.style.bottom = positions.bottom;
            } else {
                // Apply default positions from data attributes
                if (el.dataset.defaultLeft) el.style.left = el.dataset.defaultLeft;
                if (el.dataset.defaultTop) el.style.top = el.dataset.defaultTop;
                if (el.dataset.defaultRight) el.style.right = el.dataset.defaultRight;
                if (el.dataset.defaultBottom) el.style.bottom = el.dataset.defaultBottom;
            }
        });
    }
    
    // Initialize positions when page loads
    initializePositions();

    // Mouse down event for draggable elements
    function dragStart(e) {
        if (!document.body.classList.contains('drag-mode')) return;
        
        e.preventDefault();
        
        // Get the target element
        const target = e.target.closest('.draggable');
        if (!target) return;
        
        // Remove active class from any previously active elements
        document.querySelectorAll('.draggable.active').forEach(el => {
            if (el !== target) el.classList.remove('active');
        });
        
        // Set this element as active
        activeElement = target;
        activeElement.classList.add('active');
        
        // Get current position of the element
        const style = window.getComputedStyle(activeElement);
        
        // Record initial touch/mouse position
        initialX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
        initialY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
        
        // Get current offsets
        xOffset = parseInt(style.left) || 0;
        yOffset = parseInt(style.top) || 0;
        
        // Add event listeners for move and end
        if (e.type === "mousedown") {
            document.addEventListener("mousemove", drag);
            document.addEventListener("mouseup", dragEnd);
        } else {
            document.addEventListener("touchmove", drag, { passive: false });
            document.addEventListener("touchend", dragEnd);
        }
    }

    // Move event
    function drag(e) {
        if (!activeElement) return;
        
        e.preventDefault();
        
        // Get current cursor/touch position
        currentX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
        currentY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
        
        // Calculate new position
        const dx = currentX - initialX;
        const dy = currentY - initialY;
        
        // Update element position
        activeElement.style.left = (xOffset + dx) + "px";
        activeElement.style.top = (yOffset + dy) + "px";
        
        // Clear any right/bottom values as we're using left/top now
        activeElement.style.right = "";
        activeElement.style.bottom = "";
    }

    // End drag event
    function dragEnd() {
        // Keep the element active for visual feedback
        // Do not clear activeElement
        
        // Remove event listeners
        document.removeEventListener("mousemove", drag);
        document.removeEventListener("mouseup", dragEnd);
        document.removeEventListener("touchmove", drag);
        document.removeEventListener("touchend", dragEnd);
    }

    // Add mouse and touch event listeners to all draggable elements
    draggables.forEach(element => {
        element.addEventListener("mousedown", dragStart);
        element.addEventListener("touchstart", dragStart, { passive: false });
    });
    
    // Make the text container click deselect active elements
    document.querySelector('.text-container').addEventListener('click', function(e) {
        // Only deselect if clicking directly on the text container (not on draggable elements)
        if (e.target === this) {
            draggables.forEach(el => el.classList.remove('active'));
            activeElement = null;
        }
    });

    // Position control actions
    const actions = {
        alignLeft: function(el) {
            el.style.left = '3mm';
            el.style.right = '';
        },
        alignCenter: function(el) {
            const container = document.querySelector('.text-container');
            const containerWidth = container.clientWidth;
            const elWidth = el.offsetWidth;
            el.style.left = `${(containerWidth - elWidth) / 2}px`;
            el.style.right = '';
        },
        alignRight: function(el) {
            el.style.right = '3mm';
            el.style.left = '';
        },
        alignTop: function(el) {
            el.style.top = '3mm';
            el.style.bottom = '';
        },
        alignMiddle: function(el) {
            const container = document.querySelector('.text-container');
            const containerHeight = container.clientHeight;
            const elHeight = el.offsetHeight;
            el.style.top = `${(containerHeight - elHeight) / 2}px`;
            el.style.bottom = '';
        },
        alignBottom: function(el) {
            el.style.bottom = '3mm';
            el.style.top = '';
        },
        reset: function(el) {
            // Reset to default positions from data attributes
            if (el.dataset.defaultLeft) {
                el.style.left = el.dataset.defaultLeft;
                el.style.right = '';
            }
            if (el.dataset.defaultTop) {
                el.style.top = el.dataset.defaultTop;
                el.style.bottom = '';
            }
            if (el.dataset.defaultRight) {
                el.style.right = el.dataset.defaultRight;
                el.style.left = '';
            }
            if (el.dataset.defaultBottom) {
                el.style.bottom = el.dataset.defaultBottom;
                el.style.top = '';
            }
        }
    };
    
    // Add event listeners to position control buttons
    document.querySelectorAll('.position-action').forEach(button => {
        button.addEventListener('click', function() {
            const action = this.dataset.action;
            if (actions[action]) {
                // If there's an active element, apply to that only
                if (document.querySelector('.draggable.active')) {
                    actions[action](document.querySelector('.draggable.active'));
                } else {
                    // Otherwise apply to all draggable elements
                    draggables.forEach(el => actions[action](el));
                }
            }
        });
    });
    
    // Toggle drag mode button
    document.getElementById('toggleDraggableBtn').addEventListener('click', function() {
        const isDragMode = document.body.classList.toggle('drag-mode');
        this.textContent = isDragMode ? 'Disable Drag Mode' : 'Enable Drag Mode';
        document.getElementById('positionControls').style.display = isDragMode ? 'block' : 'none';
        
        // Show outlines for all draggable elements when in drag mode
        if (isDragMode) {
            draggables.forEach(el => el.classList.add('draggable-visible'));
        } else {
            draggables.forEach(el => {
                if (!el.classList.contains('active')) {
                    el.classList.remove('draggable-visible');
                }
                el.classList.remove('active');
            });
            activeElement = null;
        }
    });
    
    // Show outlines checkbox
    document.getElementById('showOutlines').addEventListener('change', function() {
        if (this.checked) {
            draggables.forEach(el => el.classList.add('draggable-visible'));
        } else {
            draggables.forEach(el => {
                if (!el.classList.contains('active')) {
                    el.classList.remove('draggable-visible');
                }
            });
        }
    });
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Setup input change listeners
    document.querySelectorAll('#settingsPanel input, #settingsPanel select').forEach(input => {
        input.addEventListener('input', updateDisplayText);
    });
    // Add these event listeners in the DOMContentLoaded section
document.getElementById('callsign1Size').addEventListener('input', updateDisplayText);
document.getElementById('callsign2Size').addEventListener('input', updateDisplayText);
    // Language selector
    document.getElementById('languageSelect').addEventListener('change', function() {
        loadLanguagePreset(this.value);
    });
    
    // Toggle settings panel
    document.getElementById('toggleSettings').addEventListener('click', function() {
        const panel = document.getElementById('settingsPanel');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            this.textContent = 'Hide Settings';
        } else {
            panel.style.display = 'none';
            this.textContent = 'Show Settings';
        }
    });
    
    // Background image
    document.getElementById('updateBgBtn').addEventListener('click', function() {
        const fileInput = document.getElementById('bgImageFile');
        if (fileInput.files && fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;
                document.querySelector('.card-content').style.backgroundImage = `url(${imageUrl})`;
                localStorage.setItem('qslCardBackground', imageUrl);
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            alert('Please select an image file');
        }
    });
    
    // Opacity control
    document.getElementById('overlayOpacity').addEventListener('input', function() {
        const opacity = this.value / 100;
        document.getElementById('opacityValue').textContent = this.value + '%';
        
        // Get overlay color and convert to rgba
        const overlayColor = document.getElementById('overlayColor').value;
        const r = parseInt(overlayColor.slice(1, 3), 16);
        const g = parseInt(overlayColor.slice(3, 5), 16);
        const b = parseInt(overlayColor.slice(5, 7), 16);
        
        // Set background opacity - set to fully transparent if 0
        if (parseInt(this.value) === 0) {
            document.querySelector('.card-overlay').style.backgroundColor = 'transparent';
        } else {
            document.querySelector('.card-overlay').style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }
    });
    
    // Print button
   // Print button
document.getElementById('printBtn').addEventListener('click', function() {
    // First disable drag mode if it's active
    if (document.body.classList.contains('drag-mode')) {
        document.getElementById('toggleDraggableBtn').click();
    }
    
    const cardContent = document.querySelector('.card-content');
    const currentBgImage = cardContent.style.backgroundImage;
    const overlay = document.querySelector('.card-overlay');
    const currentOpacity = overlay.style.backgroundColor;
    
    // Get the current text color
    const currentTextColor = document.getElementById('textColor').value;
    
    // Apply the current background image and text color directly for printing
    const style = document.createElement('style');
  // In the print button handler, fix the media query:
style.textContent = `
    @media print {
        #displayCallsign1 {
            font-size: ${document.getElementById('callsign1Size').value}mm !important;
        }
        #displayCallsign2 {
            font-size: ${document.getElementById('callsign2Size').value}mm !important;
        }
        
        .card-content {
            background-image: ${currentBgImage || 'none'} !important;
        }
        .card-overlay {
            background-color: ${currentOpacity || 'rgba(26, 123, 205, 0.3)'} !important;
        }
        .callsign, .subtitle, .location, .grid {
            color: ${currentTextColor} !important;
            text-shadow: 1mm 1mm 2mm rgba(0, 0, 0, 0.7) !important;
        }
    }
`;
`;
    `;
    document.head.appendChild(style);
    
    setTimeout(() => {
        try {
            window.print();
        } catch (e) {
            console.error("Print error:", e);
            alert("Print functionality not available. Please use your browser's print function (Ctrl+P or Cmd+P).");
        }
    }, 100);
});;
    
    // Save settings button
    document.getElementById('saveSettingsBtn').addEventListener('click', function() {
        const settings = getCurrentSettings();
        const settingsJson = JSON.stringify(settings);
        
        try {
            localStorage.setItem('qslCardSettings', settingsJson);
            alert('Settings saved successfully!');
        } catch (e) {
            console.error('Error saving settings:', e);
            alert('Error saving settings. The settings file might be too large.');
            
            // Offer download as alternative if localStorage fails
            if (confirm('Would you like to download the settings as a file instead?')) {
                const blob = new Blob([settingsJson], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'qsl_card_settings.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }
    });
    
    // Load settings button
    document.getElementById('loadSettingsBtn').addEventListener('click', function() {
        // Try loading from localStorage first
        const savedSettings = localStorage.getItem('qslCardSettings');
        
        if (savedSettings) {
            try {
                const settings = JSON.parse(savedSettings);
                applySettings(settings);
                alert('Settings loaded successfully!');
            } catch (e) {
                console.error('Error parsing saved settings:', e);
                alert('Error loading settings. The saved settings might be corrupted.');
            }
        } else {
            // If no localStorage settings, offer file upload
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            
            fileInput.onchange = function(e) {
                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const settings = JSON.parse(e.target.result);
                            applySettings(settings);
                            alert('Settings loaded successfully from file!');
                        } catch (err) {
                            console.error('Error parsing settings file:', err);
                            alert('Error loading settings. The file might be corrupted or invalid.');
                        }
                    };
                    reader.readAsText(fileInput.files[0]);
                }
            };
            
            fileInput.click();
        }
    });
    
    // Save as File button
    document.getElementById('saveAsBtn').addEventListener('click', function() {
        const settings = getCurrentSettings();
        const settingsJson = JSON.stringify(settings, null, 2); // Pretty-print with indentation
        
        const blob = new Blob([settingsJson], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'qsl_card_settings.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
    
    // Reset button
    document.getElementById('resetBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to reset all settings to default?')) {
            // Reset to English preset
            loadLanguagePreset('en');
            document.getElementById('languageSelect').value = 'en';
            
            // Reset colors
            document.getElementById('cardBorderColor').value = '#1a4e8c';
            document.getElementById('textColor').value = '#E6B800';
            document.getElementById('overlayColor').value = '#1a7bcd';
            document.getElementById('overlayOpacity').value = 30;
            document.getElementById('opacityValue').textContent = '30%';
            
			// In the reset button click handler, add:
document.getElementById('callsign1Size').value = 16;
document.getElementById('callsign2Size').value = 16;
document.getElementById('callsign1SizeValue').textContent = '16mm';
document.getElementById('callsign2SizeValue').textContent = '16mm';
			
			
            // Reset fonts
            document.getElementById('cardFont').value = 'Arial, sans-serif';
            document.getElementById('qsoFont').value = 'Arial, sans-serif';
            
            // Reset background image
            document.querySelector('.card-content').style.backgroundImage = '';
            document.querySelector('.card-content').style.backgroundColor = 'transparent';
            document.querySelector('.card-overlay').style.backgroundColor = 'rgba(26, 123, 205, 0.3)';
            document.getElementById('overlayOpacity').value = 30;
            document.getElementById('opacityValue').textContent = '30%';
            localStorage.removeItem('qslCardBackground');
            
			
			
			
            // Reset positions of all draggable elements
            document.querySelectorAll('.draggable').forEach(el => {
                el.style.left = el.dataset.defaultLeft || '';
                el.style.top = el.dataset.defaultTop || '';
                el.style.right = el.dataset.defaultRight || '';
                el.style.bottom = el.dataset.defaultBottom || '';
                
                // Remove any active state
                el.classList.remove('active');
            });
            
            // Reset QSO details
            document.querySelectorAll('.qso-table input[type="text"]').forEach(input => {
                input.value = '';
            });
            
            document.querySelectorAll('.qso-table input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Disable drag mode if it's active
            if (document.body.classList.contains('drag-mode')) {
                document.getElementById('toggleDraggableBtn').click();
            }
            
            // Update display
            updateDisplayText();
        }
    });
    
    // Initialize
    // Load background if saved previously
    if (localStorage.getItem('qslCardBackground')) {
        document.querySelector('.card-content').style.backgroundImage = 
            'url(' + localStorage.getItem('qslCardBackground') + ')';
    }
    
    // Check for saved settings
    const savedSettings = localStorage.getItem('qslCardSettings');
    if (savedSettings) {
        try {
            const settings = JSON.parse(savedSettings);
            applySettings(settings);
            // Set language selector to custom since we're loading saved settings
            document.getElementById('languageSelect').value = 'custom';
        } catch (e) {
            console.error('Error loading saved settings:', e);
            // If error, load default English
            loadLanguagePreset('en');
        }
    } else {
        // No saved settings, initialize with English
        loadLanguagePreset('en');
    }
    
    // Initialize draggable functionality
    setupDraggable();
    
    // Update display initially
    updateDisplayText();
});
</script>
</body>
</html>
